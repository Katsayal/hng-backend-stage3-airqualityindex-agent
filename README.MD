# üåç Telex Air Quality Index (AQI) AI Agent

An intelligent FastAPI-based agent that provides **real-time Air Quality Index (AQI)** information for any city worldwide.  
It integrates with **Telex**, **Google Gemini**, and the **World Air Quality Index (WAQI)** API to understand natural language and respond conversationally ‚Äî via both **webhooks** and **WebSocket**.



## üß† Overview

This AI agent:
- Understands **free-form messages** like  
  > ‚ÄúWhat‚Äôs the air quality in Kaduna right now?‚Äù  
  > ‚ÄúAQI for New York please‚Äù  
  > ‚ÄúAnd what about Abuja?‚Äù  
- Extracts the **city name** using **Gemini AI** (with regex fallback).  
- Fetches real-time **AQI data** from [WAQI](https://waqi.info).  
- Generates natural summaries (e.g., ‚ÄúAir quality in London is good (AQI 45).‚Äù)  
- Supports **persistent conversation sessions** through **WebSockets** or `session_id`s in the webhook URL.  
- Has full **logging**, **error handling**, and **validation**.


## üèóÔ∏è Project Structure

```

airqualityindex_agent/
‚îÇ
‚îú‚îÄ‚îÄ main.py                     # FastAPI entry point
‚îú‚îÄ‚îÄ models.py                   # Pydantic models for requests/responses
‚îú‚îÄ‚îÄ requirements.txt             # Dependencies
‚îú‚îÄ‚îÄ Procfile                     # Deployment process file
‚îú‚îÄ‚îÄ .env                         # Environment variables
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ aqi_service.py           # Fetches AQI data from WAQI API
‚îÇ   ‚îú‚îÄ‚îÄ gemini_service.py        # Summarizes air quality using Gemini
‚îÇ   ‚îî‚îÄ‚îÄ telex_integration.py     # Handles Telex events + location extraction
‚îÇ
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ validators.py            # Input/output validation & normalization
‚îÇ   ‚îî‚îÄ‚îÄ errors.py                # Centralized exception handler
‚îÇ
‚îî‚îÄ‚îÄ **pycache**/

````


## üöÄ Setup Instructions

### 1Ô∏è‚É£ Clone the Repository

```bash
git clone https://github.com/Katsayal/hng-backend-stage3-airqualityindex-agent.git
cd hng-backend-stage3-airqualityindex-agent
````


### 2Ô∏è‚É£ Create and Activate a Virtual Environment

```bash
python -m venv venv
# On Windows:
venv\Scripts\activate
# On macOS/Linux:
source venv/bin/activate
```


### 3Ô∏è‚É£ Install Dependencies

```bash
pip install -r requirements.txt
```


### 4Ô∏è‚É£ Create Your `.env` File

Create a `.env` file in the root directory with the following contents:

```ini
# .env
GEMINI_API_KEY=your_google_gemini_api_key_here
WAQI_TOKEN=your_waqi_token_here
TELEX_WEBHOOK_URL=https://api.telex.im/agents/webhook
ENV=development
HOST=0.0.0.0
PORT=8000
LOG_LEVEL=info
```

> üîë You can get your WAQI token from [https://aqicn.org/data-platform/token/](https://aqicn.org/data-platform/token/)
> üîë You can generate your Gemini API key from [https://makersuite.google.com/app/apikey](https://makersuite.google.com/app/apikey)


### 5Ô∏è‚É£ Run the Application

```bash
uvicorn main:app --reload
```

The agent will start on:

```
http://localhost:8000
```

---

## ‚ö° API Endpoints

### ‚úÖ **GET /**

Health & info check.

**Response:**

```json
{
  "message": "üåç Telex AQI Agent is running!",
  "endpoints": {
    "health": "/health",
    "webhook": "/webhook",
    "websocket": "/ws"
  }
}
```


### ‚úÖ **POST /webhook**

Handles Telex-style messages via HTTP.

**Request Example:**

```json
{
  "type": "message",
  "data": { "text": "What's the air quality in London right now?" }
}
```

**Response Example:**

```json
{
  "type": "message",
  "data": {
    "location": "London",
    "aqi": 45,
    "summary": "Air quality in London is good (AQI 45)."
  }
}
```

**Optional Query or Header for Sessions:**

```
POST /webhook?session_id=user123
```

or

```
Header: X-Session-ID: user123
```

This allows the agent to remember the last city mentioned in the same session.

---

### ‚úÖ **WebSocket /ws**

Interactive, real-time conversation endpoint.

**Example flow:**

```
Client ‚Üí {"type": "message", "data": {"text": "What's the AQI in Lagos?"}}
Agent  ‚Üí {"type": "message", "data": {"location": "Lagos", "aqi": 67, "summary": "Air quality in Lagos is moderate (AQI 67)."}}

Client ‚Üí {"type": "message", "data": {"text": "And what about Abuja?"}}
Agent  ‚Üí {"type": "message", "data": {"location": "Abuja", "aqi": 82, "summary": "Air quality in Abuja is moderate (AQI 82)."}}
```

Each WebSocket connection has its own **session memory**.

---

## üß© Core Features

| Feature                               | Description                                      |
| ------------------------------------- | ------------------------------------------------ |
| üåê **Natural Language Understanding** | Uses Gemini + regex to extract cities from text. |
| üí® **Real-time AQI Data**             | Fetches from WAQI API with live results.         |
| üß† **Memory**                         | Remembers last city per session or user.         |
| üîê **Validation**                     | All outputs validated via `validators.py`.       |
| üìú **Logging**                        | Timestamped structured logs for all events.      |
| üßØ **Error Handling**                 | Graceful fallback responses for all exceptions.  |

---

## üß∞ Tech Stack

* **Python 3.11+**
* **FastAPI** (async web framework)
* **Google Gemini API**
* **WAQI (World Air Quality Index) API**
* **Pydantic** (data models & validation)
* **dotenv** (environment management)
* **Uvicorn** (ASGI server)

---

## üîç Logs and Debugging

Logs are shown in your terminal in structured format:

```
[2025-11-01 20:03:58] INFO - Received message: "What's the air quality in London right now?"
[2025-11-01 20:04:02] INFO - Generated summary: Air quality in London is good (AQI 45).
```

---

## üß™ Testing Locally

You can test the webhook endpoint using `curl` or Postman:

```bash
curl -X POST http://127.0.0.1:8000/webhook \
-H "Content-Type: application/json" \
-d '{"type": "message", "data": {"text": "What‚Äôs the air quality in Lagos?"}}'
```

## ‚ö†Ô∏è Troubleshooting

| Issue                                                              | Cause                              | Fix                                                                        |
| ------------------------------------------------------------------ | ---------------------------------- | -------------------------------------------------------------------------- |
| `ValueError: GEMINI_API_KEY not set in environment`                | `.env` not loaded before import    | Add `load_dotenv()` at top of `telex_integration.py`                       |
| `Gemini extraction error: Your default credentials were not found` | Gemini SDK trying to use ADC       | Ensure `genai.configure(api_key=...)` runs after `.env` loaded             |
| `"Unknown station"` from WAQI                                      | City not recognized                | Try using broader location (e.g., "London" instead of "London right now")  |
| WebSocket disconnects quickly                                      | Missing `await` or invalid payload | Make sure to send full `{"type": "message", "data": {"text": "..."}}` JSON |

